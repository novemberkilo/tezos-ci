version: "3.8"
services:
  tezos-ci:
    build:
      context: ..
    command: "--ocluster-cap /secrets/${OCLUSTER_CAP_FILE} --gitlab-token-file=/secrets/${GITLAB_TOKEN_FILE} --gitlab-webhook-secret-file=/dev/null --listen-prometheus=9090"
    init: true
    ports:
      - "8080:8080"
    volumes:
      - "../../:/secrets"
  grafana:
    build: './grafana'
    ports:
      - "3000:3000"
    #volumes:
    #  - "./grafana-config:/var/lib/grafana"
  prometheus:
    image: prom/prometheus
    command: --storage.tsdb.retention.time=30w --config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/prometheus --web.console.libraries=/usr/share/prometheus/console_libraries --web.console.templates=/usr/share/prometheus/consoles
    ports:
      - "9090:9090"
    volumes:
      - "prometheus-data:/prometheus"
      - "./prometheus:/etc/prometheus:ro"
volumes:
  prometheus-data:
